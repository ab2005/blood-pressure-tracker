<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Health Tracker - Voice Assistant</title>
    <link rel="manifest" href="/manifest.json">
    
    <!-- iOS-specific meta tags for PWA support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="HealthTracker">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%234CAF50'/><path d='M256 64c-35.3 0-64 28.7-64 64v32h-32c-17.7 0-32 14.3-32 32v256c0 17.7 14.3 32 32 32h192c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32h-32v-32c0-35.3-28.7-64-64-64zm0 32c17.7 0 32 14.3 32 32v32h-64v-32c0-17.7 14.3-32 32-32z' fill='white'/><circle cx='256' cy='300' r='20' fill='%234CAF50'/></svg>">
    <link rel="apple-touch-startup-image" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 390 844'><rect width='390' height='844' fill='%234CAF50'/><text x='195' y='422' text-anchor='middle' font-family='Arial' font-size='48' fill='white'>Health Tracker</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
            margin-bottom: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .status-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 5px solid #4CAF50;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .status-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
        }

        .status-card.active {
            border-color: #4CAF50;
            background: #e8f5e8;
        }

        .status-card.inactive {
            border-color: #f44336;
            background: #ffebee;
        }

        .status-card h3 {
            font-size: 0.9rem;
            color: #333;
            margin-bottom: 8px;
        }

        .status-card p {
            font-size: 0.8rem;
            color: #666;
            font-weight: 600;
        }

        .controls-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 5px solid #2196f3;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        button.secondary {
            background: linear-gradient(135deg, #2196f3, #1976d2);
        }

        button.warning {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }

        button.danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }


        .voice-section {
            background: linear-gradient(135deg, #9c27b0, #7b1fa2);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin-bottom: 25px;
        }

        .voice-section h2 {
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .voice-commands {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            text-align: left;
        }

        .voice-commands h3 {
            margin-bottom: 10px;
            color: #fff;
        }

        .voice-commands ul {
            list-style: none;
            padding: 0;
        }

        .voice-commands li {
            margin: 8px 0;
            padding: 5px 0;
            color: rgba(255, 255, 255, 0.9);
        }

        .voice-commands li::before {
            content: "üé§ ";
            margin-right: 8px;
        }

        .log-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid #ff9800;
        }

        .log {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 5px;
            border-radius: 3px;
        }

        .log-entry.success {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .log-entry.error {
            background: #ffebee;
            color: #c62828;
        }

        .log-entry.info {
            background: #e3f2fd;
            color: #1565c0;
        }

        .ios-install-banner {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            border-radius: 15px;
            margin-bottom: 25px;
            animation: slideDown 0.5s ease;
        }

        .banner-content {
            display: flex;
            align-items: center;
            padding: 20px;
            gap: 15px;
        }

        .banner-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .banner-text {
            flex: 1;
        }

        .banner-text h3 {
            margin: 0 0 5px 0;
            font-size: 1.1rem;
        }

        .banner-text p {
            margin: 0;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .banner-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .install-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .install-btn:hover {
            background: white;
            color: #ff9800;
        }

        .dismiss-btn {
            background: none;
            color: white;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .dismiss-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
                flex-direction: column;
                gap: 10px;
            }
            
            .status-grid,
            .controls-grid {
                grid-template-columns: 1fr;
            }

            .banner-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .banner-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Health Tracker <span style="font-size: 1.5rem;">üé§</span></h1>
            <p>Voice-controlled health event management with intelligent notifications</p>
        </div>

        <!-- iOS Installation Banner (hidden by default) -->
        <div class="ios-install-banner" id="ios-install-banner" style="display: none;">
            <div class="banner-content">
                <div class="banner-icon">üì±</div>
                <div class="banner-text">
                    <h3>Install for Better Notifications</h3>
                    <p>Add this app to your Home Screen for reliable system notifications on iOS</p>
                </div>
                <div class="banner-actions">
                    <button onclick="showIOSInstallInstructions()" class="install-btn">Install App</button>
                    <button onclick="hideIOSBanner()" class="dismiss-btn">‚úï</button>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="status-section">
            <h2>üîß System Status</h2>
            <div class="status-grid" id="system-status">
                <div class="status-card" id="event-scheduler-status">
                    <h3>Event Scheduler</h3>
                    <p id="event-scheduler-text">Loading...</p>
                </div>
                <div class="status-card" id="notification-manager-status">
                    <h3>Notifications</h3>
                    <p id="notification-manager-text">Loading...</p>
                </div>
                <div class="status-card" id="agent-tools-status">
                    <h3>Agent Tools</h3>
                    <p id="agent-tools-text">Loading...</p>
                </div>
                <div class="status-card" id="service-worker-status">
                    <h3>Service Worker</h3>
                    <p id="service-worker-text">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Quick Controls -->
        <div class="controls-section">
            <h2>‚ö° Quick Actions</h2>
            <div class="controls-grid">
                <button onclick="testNotifications()">üîî Test Notifications</button>
                <button onclick="testIOSNotifications()" class="warning">üì± Test iOS Notifications</button>
                <button onclick="debugBasicNotification()" class="warning">üîç Debug Basic Notification</button>
                <button onclick="createQuickReminder()" class="secondary">‚è∞ Quick Reminder</button>
                <button onclick="listEvents()" class="secondary">üìã List Events</button>
                <button onclick="getStats()" class="secondary">üìä Statistics</button>
                <button onclick="requestPermissions()" class="warning">üîê Enable Permissions</button>
                <button onclick="showBrowserInfo()" class="secondary">‚ÑπÔ∏è Browser Info</button>
                <button onclick="clearTestData()" class="danger">üßπ Clear Test Data</button>
            </div>
        </div>

        <!-- Voice Commands -->
        <div class="voice-section">
            <h2>üé§ Voice Assistant Ready</h2>
            <p>Start talking to create events, set reminders, and manage your health schedule</p>
            
            <div class="voice-commands">
                <h3>üìù Example Voice Commands:</h3>
                <ul>
                    <li>"Set a medication reminder for aspirin at 8 AM daily"</li>
                    <li>"Remind me to check my blood pressure tomorrow at 9 PM"</li>
                    <li>"What are my pending reminders?"</li>
                    <li>"Cancel my aspirin reminder"</li>
                    <li>"Snooze my blood pressure check for 15 minutes"</li>
                    <li>"Mark my medication as taken"</li>
                    <li>"Test my notifications"</li>
                    <li>"Show my event statistics"</li>
                </ul>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="log-section">
            <h2>üìã Activity Log</h2>
            <button onclick="clearLog()" class="danger" style="font-size: 12px; padding: 8px 12px;">Clear Log</button>
            <div id="activity-log" class="log"></div>
        </div>
    </div>
    <!-- Load Event System Components -->
    <script src="event-scheduler.js"></script>
    <script src="notification-manager.js"></script>
    <script src="agent-event-tools.js"></script>
    <script src="client-tools.js"></script>
    <script src="el-widget.js"></script>
    <script>
        // Global state
        let eventScheduler = null;
        let notificationManager = null;
        let activityLog = [];

        // Initialize the complete system
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM loaded, initializing health tracker...');
            
            try {
                await initializeHealthSystem();
                await initializeElevenLabsWidget();
                
                // Set up event listeners for system updates
                setupEventListeners();
                
                // Check if we should show iOS installation banner
                checkAndShowIOSBanner();
                
                
                logActivity('success', 'Health Tracker initialized successfully');
            } catch (error) {
                logActivity('error', 'Failed to initialize system: ' + error.message);
            }
        });

        // Initialize health event system
        async function initializeHealthSystem() {
            try {
                // Initialize event scheduler
                if (window.EventScheduler) {
                    eventScheduler = new EventScheduler();
                    window.eventScheduler = eventScheduler;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    updateSystemStatus('event-scheduler', true, 'Active');
                } else {
                    updateSystemStatus('event-scheduler', false, 'Not Loaded');
                }

                // Initialize notification manager
                if (window.NotificationManager) {
                    notificationManager = new NotificationManager();
                    window.notificationManager = notificationManager;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // If we're in PWA mode on iOS, process any pending notifications
                    if (notificationManager.isIOS && (notificationManager.isStandalone || notificationManager.isInPWA)) {
                        await notificationManager.processPendingIOSNotifications();
                        logActivity('success', 'Processed pending iOS notifications');
                    }
                    
                    updateSystemStatus('notification-manager', true, 'Active');
                } else {
                    updateSystemStatus('notification-manager', false, 'Not Loaded');
                }

                // Check agent tools
                if (window.AgentEventTools) {
                    updateSystemStatus('agent-tools', true, 'Active');
                } else {
                    updateSystemStatus('agent-tools', false, 'Not Loaded');
                }

                // Register service worker
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.register('sw-notifications.js');
                        updateSystemStatus('service-worker', true, 'Registered');
                        logActivity('success', 'Service worker registered');
                    } catch (error) {
                        updateSystemStatus('service-worker', false, 'Failed');
                        logActivity('error', 'Service worker registration failed');
                    }
                } else {
                    updateSystemStatus('service-worker', false, 'Not Supported');
                }

            } catch (error) {
                logActivity('error', 'Health system initialization failed: ' + error.message);
                throw error;
            }
        }

        // Initialize ElevenLabs widget
        async function initializeElevenLabsWidget() {
            try {
                logActivity('info', 'Injecting ElevenLabs widget...');
                injectElevenLabsWidget();

                // Debug: Check if widget was created
                setTimeout(() => {
                    const widget = document.querySelector('elevenlabs-convai');
                    if (widget) {
                        logActivity('success', 'ElevenLabs widget loaded successfully');
                    } else {
                        logActivity('error', 'ElevenLabs widget not found in DOM');
                    }
                }, 2000);
            } catch (error) {
                logActivity('error', 'Widget initialization failed: ' + error.message);
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Listen for notification events
            document.addEventListener('notification:notificationClicked', (event) => {
                logActivity('info', 'Notification clicked: ' + event.detail.notification.title);
            });

            document.addEventListener('notification:notificationAction', (event) => {
                logActivity('info', 'Notification action: ' + event.detail.action);
            });

            // Listen for service worker messages
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data.type === 'SHOW_IN_APP_NOTIFICATION') {
                        logActivity('info', 'In-app notification: ' + event.data.data.title);
                    }
                });
            }
        }

        // Update system status display
        function updateSystemStatus(component, isActive, statusText) {
            const statusElement = document.getElementById(`${component}-status`);
            const textElement = document.getElementById(`${component}-text`);
            
            if (statusElement && textElement) {
                statusElement.className = isActive ? 'status-card active' : 'status-card inactive';
                textElement.textContent = statusText;
            }
        }

        // Log activity
        function logActivity(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { type, message, timestamp };
            
            activityLog.push(logEntry);
            
            const logContainer = document.getElementById('activity-log');
            if (logContainer) {
                const logDiv = document.createElement('div');
                logDiv.className = `log-entry ${type}`;
                logDiv.textContent = `[${timestamp}] ${message}`;
                
                logContainer.appendChild(logDiv);
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // Keep only last 50 entries
                const entries = logContainer.querySelectorAll('.log-entry');
                if (entries.length > 50) {
                    entries[0].remove();
                }
            }
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Quick action functions
        async function testNotifications() {
            try {
                if (!notificationManager) {
                    throw new Error('Notification manager not available');
                }
                
                await notificationManager.testNotifications();
                logActivity('success', 'Test notification sent - check for notification popup');
            } catch (error) {
                logActivity('error', 'Notification test failed: ' + error.message);
            }
        }

        // iOS-specific notification testing
        async function testIOSNotifications() {
            try {
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isStandalone = window.navigator.standalone === true;
                const isInPWA = window.matchMedia('(display-mode: standalone)').matches;
                
                logActivity('info', 'üì± Testing iOS-optimized notifications...');
                
                if (!isIOS) {
                    logActivity('info', 'Not an iOS device - using standard notification test');
                    return testNotifications();
                }
                
                // Detailed iOS diagnostics
                const userAgent = navigator.userAgent;
                let iOSVersion = 'Unknown';
                const match = userAgent.match(/OS (\d+)_(\d+)_?(\d+)?/);
                if (match) {
                    iOSVersion = `${match[1]}.${match[2]}.${match[3] || 0}`;
                }
                
                logActivity('info', `iOS ${iOSVersion} detected - PWA mode: ${isStandalone || isInPWA}`);
                
                // Safe check for Notification API
                const hasNotificationAPI = 'Notification' in window;
                logActivity('info', `Notification API: ${hasNotificationAPI ? 'Available' : 'Not available'}`);
                
                if (hasNotificationAPI) {
                    logActivity('info', `Permission: ${Notification.permission}`);
                } else {
                    logActivity('error', 'Notification API not available - using visual fallbacks only');
                }
                
                // Check notification support based on iOS version
                const majorVersion = parseInt(iOSVersion.split('.')[0]);
                if (majorVersion < 16) {
                    logActivity('error', '‚ùå iOS version too old for web notifications (requires iOS 16.4+)');
                    logActivity('info', 'üí° Will use visual + vibration fallbacks only');
                } else if (!isStandalone && !isInPWA) {
                    logActivity('error', '‚ö†Ô∏è Browser mode - system notifications unreliable');
                    logActivity('info', 'üí° Install as PWA for reliable system notifications');
                }
                
                // Force visual + vibration + audio for iOS
                if (window.eventScheduler && window.notificationManager) {
                    const testEventData = {
                        title: 'üì± iOS Test Notification',
                        description: `Testing on iOS ${iOSVersion} - ${isStandalone || isInPWA ? 'PWA' : 'Browser'} mode`,
                        category: 'test',
                        datetime: new Date(Date.now() + 2000).toISOString(), // 2 seconds
                        notifications: {
                            enabled: true,
                            methods: hasNotificationAPI ? ['system', 'visual', 'vibration', 'sound'] : ['visual', 'vibration', 'sound'],
                            priority: 'high'
                        },
                        createdBy: 'ios-test'
                    };
                    
                    const testEvent = await window.eventScheduler.createEvent(testEventData);
                    await window.notificationManager.showNotification(testEvent);
                    
                    logActivity('success', 'iOS test notification sent with available methods');
                    
                    if (hasNotificationAPI && (isStandalone || isInPWA)) {
                        logActivity('info', 'You should see: system notification + visual popup + vibration');
                    } else if (hasNotificationAPI) {
                        logActivity('info', 'You should see: visual popup + vibration (system notification may not work in browser mode)');
                        logActivity('info', 'üí° Tip: Add to Home Screen for reliable system notifications');
                    } else {
                        logActivity('info', 'You should see: visual popup + vibration (Notification API not available)');
                        logActivity('info', 'üí° This iOS version doesn\'t support web notifications');
                    }
                    
                    // Show pending notifications count
                    const stats = window.notificationManager.getStatistics();
                    if (stats.pendingIOSNotifications > 0) {
                        logActivity('info', `üìã ${stats.pendingIOSNotifications} notifications pending for PWA mode`);
                    }
                    
                } else {
                    logActivity('error', 'Event scheduler or notification manager not available');
                }
                
            } catch (error) {
                logActivity('error', 'iOS notification test failed: ' + error.message);
            }
        }

        // Debug function for basic notification testing
        async function debugBasicNotification() {
            try {
                logActivity('info', 'üîç Testing basic browser notification...');
                
                // Check if Notification API is available
                if (!('Notification' in window) || typeof Notification === 'undefined') {
                    logActivity('error', 'Notification API not available - using visual fallback test');
                    return testIOSNotifications(); // Fallback to iOS test which handles this case
                }
                
                // Check permission first
                if (Notification.permission !== 'granted') {
                    logActivity('error', 'Notifications not permitted. Click "Enable Permissions" first.');
                    return;
                }
                
                // Test basic notification without service worker
                logActivity('info', 'Creating basic notification...');
                const notification = new Notification('Debug Test Notification', {
                    body: 'This is a basic browser notification test',
                    icon: '/favicon.ico',
                    tag: 'debug-test',
                    requireInteraction: false
                });
                
                notification.onclick = () => {
                    logActivity('success', '‚úÖ Basic notification clicked!');
                    notification.close();
                };
                
                notification.onshow = () => {
                    logActivity('success', '‚úÖ Basic notification shown successfully!');
                };
                
                notification.onerror = (error) => {
                    logActivity('error', '‚ùå Basic notification error: ' + error);
                };
                
                logActivity('info', 'Basic notification created - should appear now');
                
            } catch (error) {
                logActivity('error', 'Debug notification failed: ' + error.message);
            }
        }

        async function createQuickReminder() {
            try {
                if (!window.ClientTools) {
                    throw new Error('Client tools not available');
                }
                
                const result = await window.ClientTools.addEvent({
                    title: 'Quick Test Reminder',
                    datetime: new Date(Date.now() + 60000).toISOString(), // 1 minute from now
                    description: 'This is a quick test reminder - you should receive a system notification with vibration in 1 minute',
                    category: 'test',
                    notifications: {
                        enabled: true,
                        methods: ['system', 'vibration'], // Focus on system notifications
                        priority: 'normal'
                    }
                });
                
                logActivity('success', 'Quick reminder created: ' + result);
                logActivity('info', 'You should receive a system notification with vibration in 1 minute');
            } catch (error) {
                logActivity('error', 'Quick reminder failed: ' + error.message);
            }
        }

        async function listEvents() {
            try {
                if (!window.ClientTools) {
                    throw new Error('Client tools not available');
                }
                
                const result = await window.ClientTools.listPendingEvents({ limit: 5 });
                logActivity('info', 'Events listed: ' + result.split('\n')[0]);
            } catch (error) {
                logActivity('error', 'List events failed: ' + error.message);
            }
        }

        async function getStats() {
            try {
                if (!window.ClientTools) {
                    throw new Error('Client tools not available');
                }
                
                const result = await window.ClientTools.getEventStatistics();
                logActivity('info', 'Statistics retrieved: ' + result.split('\n')[2]); // Show summary line
            } catch (error) {
                logActivity('error', 'Statistics failed: ' + error.message);
            }
        }

        async function requestPermissions() {
            try {
                // Detailed permission debugging
                logActivity('info', 'Checking notification support...');
                
                // Browser and environment detection
                const userAgent = navigator.userAgent;
                const isHTTPS = location.protocol === 'https:';
                const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                const isFileProtocol = location.protocol === 'file:';
                
                logActivity('info', `Browser: ${userAgent.split(' ').pop()}`);
                logActivity('info', `Protocol: ${location.protocol} (HTTPS: ${isHTTPS}, Localhost: ${isLocalhost})`);
                
                if (isFileProtocol) {
                    logActivity('error', '‚ùå File:// protocol detected - notifications may not work. Use a web server.');
                    return;
                }
                
                if (!isHTTPS && !isLocalhost) {
                    logActivity('error', '‚ùå Non-HTTPS connection detected - notifications require HTTPS or localhost');
                    return;
                }
                
                if (!('Notification' in window)) {
                    logActivity('error', '‚ùå This browser does not support the Notification API');
                    logActivity('info', 'Supported browsers: Chrome 22+, Firefox 22+, Safari 7+, Edge 14+');
                    logActivity('info', 'Try updating your browser or use Chrome/Firefox');
                    return;
                }
                
                // Check current permission status safely
                if ('Notification' in window && typeof Notification !== 'undefined') {
                    logActivity('info', 'Current notification permission: ' + Notification.permission);
                } else {
                    logActivity('info', 'Current notification permission: Not available');
                }
                
                // Request notification permission with safety checks
                if ('Notification' in window && typeof Notification !== 'undefined') {
                    try {
                        if (Notification.permission === 'default') {
                            logActivity('info', 'Requesting notification permission...');
                            const permission = await Notification.requestPermission();
                            logActivity('info', 'Permission result: ' + permission);
                            
                            if (permission === 'granted') {
                                logActivity('success', '‚úÖ Notification permission granted!');
                            } else if (permission === 'denied') {
                                logActivity('error', '‚ùå Notification permission denied - check browser settings');
                            } else {
                                logActivity('info', 'Notification permission dismissed');
                            }
                        } else if (Notification.permission === 'granted') {
                            logActivity('success', '‚úÖ Notifications already permitted');
                        } else {
                            logActivity('error', '‚ùå Notifications are blocked - check browser settings');
                        }
                    } catch (error) {
                        logActivity('error', 'Failed to request notification permission: ' + error.message);
                        logActivity('info', 'üí° Notification API may not be available on this iOS version');
                    }
                } else {
                    logActivity('error', '‚ùå Notification API not available');
                    logActivity('info', 'üí° This iOS version/browser doesn\'t support web notifications');
                    logActivity('info', 'üí° Visual notifications and vibration will still work');
                }
                
                // Test vibration
                if ('vibrate' in navigator) {
                    navigator.vibrate(200);
                    logActivity('success', 'Vibration test successful');
                } else {
                    logActivity('info', 'Vibration not supported');
                }
                
                // Service Worker check
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.ready;
                        logActivity('success', 'Service Worker ready for notifications');
                    } catch (error) {
                        logActivity('error', 'Service Worker not ready: ' + error.message);
                    }
                } else {
                    logActivity('error', 'Service Worker not supported');
                }
                
                // Update status
                if (notificationManager) {
                    await notificationManager.checkPermissions();
                    logActivity('success', 'Permissions updated');
                }
                
            } catch (error) {
                logActivity('error', 'Permission request failed: ' + error.message);
            }
        }

        async function clearTestData() {
            try {
                if (!eventScheduler) {
                    throw new Error('Event scheduler not available');
                }
                
                const events = await eventScheduler.searchEvents({ query: 'test' });
                let cleaned = 0;
                
                for (const event of events) {
                    if (event.category === 'test' || event.title.toLowerCase().includes('test')) {
                        await eventScheduler.deleteEvent(event.id);
                        cleaned++;
                    }
                }
                
                logActivity('success', `Cleaned up ${cleaned} test events`);
            } catch (error) {
                logActivity('error', 'Cleanup failed: ' + error.message);
            }
        }

        function showBrowserInfo() {
            try {
                const userAgent = navigator.userAgent;
                const isHTTPS = location.protocol === 'https:';
                const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                const isFileProtocol = location.protocol === 'file:';
                const notificationSupport = 'Notification' in window;
                const serviceWorkerSupport = 'serviceWorker' in navigator;
                const vibrationSupport = 'vibrate' in navigator;
                
                // iOS detection
                const isIOS = /iPad|iPhone|iPod/.test(userAgent);
                const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
                const isIOSChrome = /CriOS/.test(userAgent);
                const isIOSFirefox = /FxiOS/.test(userAgent);
                const isStandalone = window.navigator.standalone === true;
                const isInPWA = window.matchMedia('(display-mode: standalone)').matches;
                
                // Extract iOS version if available
                let iOSVersion = null;
                if (isIOS) {
                    const match = userAgent.match(/OS (\d+)_(\d+)_?(\d+)?/);
                    if (match) {
                        iOSVersion = `${match[1]}.${match[2]}.${match[3] || 0}`;
                    }
                }
                
                logActivity('info', 'üåê Browser Environment Information:');
                logActivity('info', `URL: ${location.href}`);
                logActivity('info', `Protocol: ${location.protocol} (Secure: ${isHTTPS || isLocalhost})`);
                logActivity('info', `User Agent: ${userAgent}`);
                
                // iOS-specific information
                if (isIOS) {
                    logActivity('info', `üì± iOS Device Detected (Version: ${iOSVersion || 'Unknown'})`);
                    logActivity('info', `Browser: ${isSafari ? 'Safari' : isIOSChrome ? 'Chrome' : isIOSFirefox ? 'Firefox' : 'Other'}`);
                    logActivity('info', `PWA Mode: ${isStandalone || isInPWA ? '‚úÖ Yes' : '‚ùå No (Add to Home Screen recommended)'}`);
                    
                    // iOS notification compatibility
                    if (iOSVersion) {
                        const majorVersion = parseInt(iOSVersion.split('.')[0]);
                        if (majorVersion >= 16) {
                            logActivity('info', '‚úÖ iOS 16.4+ detected - web notifications may be supported');
                            if (!isStandalone && !isInPWA) {
                                logActivity('error', '‚ö†Ô∏è For best results, add this app to Home Screen (PWA mode)');
                            }
                        } else {
                            logActivity('error', '‚ùå iOS version too old for web notifications (requires iOS 16.4+)');
                            logActivity('info', 'üí° Update iOS or use alternative notification methods');
                        }
                    }
                }
                
                logActivity('info', `Notification API: ${notificationSupport ? '‚úÖ Supported' : '‚ùå Not supported'}`);
                logActivity('info', `Service Worker: ${serviceWorkerSupport ? '‚úÖ Supported' : '‚ùå Not supported'}`);
                logActivity('info', `Vibration API: ${vibrationSupport ? '‚úÖ Supported' : '‚ùå Not supported'}`);
                
                if (notificationSupport) {
                    logActivity('info', `Current permission: ${Notification.permission}`);
                }
                
                // Recommendations
                if (isFileProtocol) {
                    logActivity('error', '‚ö†Ô∏è File protocol detected - use a web server instead');
                    logActivity('info', 'üí° Try: python -m http.server 8000 or npx serve');
                }
                
                if (!isHTTPS && !isLocalhost) {
                    logActivity('error', '‚ö†Ô∏è Non-secure connection - notifications require HTTPS');
                    logActivity('info', 'üí° Use localhost or enable HTTPS');
                }
                
                if (!notificationSupport) {
                    logActivity('error', '‚ö†Ô∏è Notification API not supported');
                    if (isIOS) {
                        logActivity('info', 'üí° iOS: Update to iOS 16.4+ and add to Home Screen');
                    } else {
                        logActivity('info', 'üí° Try Chrome 22+, Firefox 22+, Safari 7+, or Edge 14+');
                    }
                }
                
                // iOS-specific recommendations
                if (isIOS && notificationSupport && !isStandalone && !isInPWA) {
                    logActivity('info', 'üí° iOS Tip: For better notifications, tap Share ‚Üí Add to Home Screen');
                }
                
            } catch (error) {
                logActivity('error', 'Failed to get browser info: ' + error.message);
            }
        }

        function clearLog() {
            activityLog = [];
            const logContainer = document.getElementById('activity-log');
            if (logContainer) {
                logContainer.innerHTML = '';
            }
            logActivity('info', 'Activity log cleared');
        }

        // iOS Installation Banner Management
        function checkAndShowIOSBanner() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isStandalone = window.navigator.standalone === true;
            const isInPWA = window.matchMedia('(display-mode: standalone)').matches;
            const bannerDismissed = localStorage.getItem('ios-banner-dismissed') === 'true';
            
            // Show banner if: iOS device + not in PWA mode + not dismissed + notifications not working
            if (isIOS && !isStandalone && !isInPWA && !bannerDismissed) {
                // Check if notifications might not work
                setTimeout(() => {
                    if (Notification.permission !== 'granted' || !('Notification' in window)) {
                        showIOSBanner();
                    }
                }, 2000); // Wait 2 seconds after page load
            }
        }

        function showIOSBanner() {
            const banner = document.getElementById('ios-install-banner');
            if (banner) {
                banner.style.display = 'block';
                logActivity('info', 'Showing iOS installation banner');
            }
        }

        function hideIOSBanner() {
            const banner = document.getElementById('ios-install-banner');
            if (banner) {
                banner.style.display = 'none';
                localStorage.setItem('ios-banner-dismissed', 'true');
                logActivity('info', 'iOS banner dismissed');
            }
        }

        function showIOSInstallInstructions() {
            logActivity('info', 'üì± iOS Installation Instructions:');
            logActivity('info', '1. Tap the Share button (üì§) at the bottom of Safari');
            logActivity('info', '2. Scroll down and tap "Add to Home Screen"');
            logActivity('info', '3. Tap "Add" to confirm');
            logActivity('info', '4. Open the app from your Home Screen');
            logActivity('info', '5. Grant notification permissions when prompted');
            logActivity('success', 'After installation, system notifications will work reliably!');
            
            // Also show visual instructions in a modal-like format
            const instructions = `
üì± How to Install on iOS:

1Ô∏è‚É£ Tap the Share button (üì§) at the bottom of Safari
2Ô∏è‚É£ Scroll down and tap "Add to Home Screen" 
3Ô∏è‚É£ Tap "Add" to confirm
4Ô∏è‚É£ Open the app from your Home Screen
5Ô∏è‚É£ Grant notification permissions when prompted

‚úÖ System notifications will then work reliably!
            `;
            
            if (confirm(instructions + '\n\nWould you like to hide this banner?')) {
                hideIOSBanner();
            }
        }

    </script>
</body>
</html>
